<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GeoPlay</title>
  <style>
    :root{ --bg:#0b0f1a; --card:rgba(255,255,255,.06); --line:rgba(255,255,255,.12); --text:#eaf0ff; --muted:rgba(234,240,255,.72); --accent:#7aa7ff; }
    [data-theme="light"]{ --bg:#f6f7fb; --card:#ffffff; --line:#e4e7f0; --text:#0b0f1a; --muted:#4b5563; --accent:#2563eb; }
    [data-theme="purple"]{ --bg:#0a0416; --card:rgba(255,255,255,.07); --line:rgba(255,255,255,.12); --text:#f2eaff; --muted:rgba(242,234,255,.72); --accent:#b37aff; }
    [data-theme="green"]{ --bg:#06140f; --card:rgba(255,255,255,.07); --line:rgba(255,255,255,.12); --text:#eafff3; --muted:rgba(234,255,243,.72); --accent:#35d07f; }

    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;backdrop-filter:blur(10px);background:color-mix(in srgb, var(--bg) 80%, transparent);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    a{color:var(--text);text-decoration:none}
    .muted{color:var(--muted)}
    .btn{border:1px solid var(--line);background:var(--card);color:var(--text);padding:9px 12px;border-radius:12px;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    select{border:1px solid var(--line);background:var(--card);color:var(--text);padding:9px 12px;border-radius:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{border:1px solid var(--line);background:var(--card);border-radius:18px;overflow:hidden}
    video{width:100%;height:180px;object-fit:cover;background:#000}
    .meta{padding:12px}
    .title{font-weight:800}
    .pill{display:inline-block;margin-top:8px;border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="row">
    <b>GeoPlay</b>
    <span class="muted" id="me">‚Ä¶</span>
  </div>
  <div class="row">
    <select id="theme">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
      <option value="purple">Purple</option>
      <option value="green">Green</option>
    </select>
    <a class="btn" href="/">Home</a>
    <a class="btn" href="/upload">Upload</a>
    <a class="btn" href="/login" id="loginBtn">Login</a>
    <button class="btn" id="logoutBtn" style="display:none">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="row" style="margin-bottom:12px">
    <select id="sort">
      <option value="trending">Trending</option>
      <option value="most_liked">Most liked</option>
      <option value="most_viewed">Most viewed</option>
      <option value="least_liked">Least liked</option>
      <option value="least_viewed">Least viewed</option>
    </select>

    <select id="cat"><option value="">All categories</option></select>
    <button class="btn" id="refresh">Refresh</button>
  </div>

  <div class="grid" id="grid"></div>
  <div class="muted" id="empty" style="display:none;margin-top:10px">No videos yet.</div>
</div>

<script>
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty");
  const cat = document.getElementById("cat");
  const sort = document.getElementById("sort");
  const refresh = document.getElementById("refresh");
  const me = document.getElementById("me");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const themeSel = document.getElementById("theme");

  function setTheme(t){
    document.documentElement.dataset.theme = (t === "dark" ? "" : t);
    localStorage.setItem("theme", t);
  }
  setTheme(localStorage.getItem("theme") || "dark");
  themeSel.value = localStorage.getItem("theme") || "dark";
  themeSel.onchange = ()=> setTheme(themeSel.value);

  async function j(url){ const r=await fetch(url); return r.json(); }

  async function loadMe(){
    const m = await j("/api/me");
    if(m.logged_in){
      me.innerHTML = `@<a href="/u/${m.username}">${m.username}</a>`;
      loginBtn.style.display="none";
      logoutBtn.style.display="inline-block";
    } else {
      me.textContent = "guest";
      loginBtn.style.display="inline-block";
      logoutBtn.style.display="none";
    }
  }

  logoutBtn.onclick = async ()=>{
    await fetch("/api/logout",{method:"POST"});
    location.reload();
  };

  async function loadCategories(){
    const c = await j("/api/categories");
    const keep = cat.value;
    cat.innerHTML = `<option value="">All categories</option>`;
    (c.categories||[]).forEach(x=>{
      const o=document.createElement("option");
      o.value=x; o.textContent=x;
      cat.appendChild(o);
    });
    cat.value = keep || "";
  }

  function card(v){
    const esc = s => String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    return `
      <div class="card">
        <a href="/v/${v.id}"><video src="${esc(v.url)}" muted preload="metadata"></video></a>
        <div class="meta">
          <div class="title"><a href="/v/${v.id}">${esc(v.title)}</a></div>
          <div class="muted">by <a href="/u/${esc(v.uploader)}">${esc(v.uploader)}</a> ‚Ä¢ ${v.views} views ‚Ä¢ üëç ${v.likes} üëé ${v.dislikes}</div>
          <div class="pill">${esc(v.category)} ‚Ä¢ ${esc(v.visibility)} ‚Ä¢ ${esc(v.rating)}</div>
        </div>
      </div>
    `;
  }

  async function loadVideos(){
    const q = new URLSearchParams();
    if(cat.value) q.set("category", cat.value);
    q.set("sort", sort.value);
    const vids = await j("/api/videos?" + q.toString());
    grid.innerHTML="";
    if(!vids.length){ empty.style.display="block"; return; }
    empty.style.display="none";
    vids.forEach(v=>{
      const d=document.createElement("div");
      d.innerHTML=card(v);
      grid.appendChild(d.firstElementChild);
    });
  }

  refresh.onclick = async ()=>{ await loadCategories(); await loadVideos(); };
  sort.onchange = loadVideos;
  cat.onchange = loadVideos;

  (async ()=>{ await loadMe(); await loadCategories(); await loadVideos(); })();
</script>
</body>
</html>
