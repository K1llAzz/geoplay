<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video HUD Player + Upload</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:rgba(10,14,24,.72); --panel2:rgba(10,14,24,.90);
      --text:#eaf0ff; --muted:rgba(234,240,255,.72); --line:rgba(234,240,255,.12);
      --accent:#7aa7ff; --good:#35d07f; --warn:#ffcf5c; --bad:#ff5c7a;
      --shadow:0 18px 60px rgba(0,0,0,.45); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .stage{position:fixed;inset:0;background:#000;overflow:hidden}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

    .hud{position:fixed;left:16px;right:16px;top:14px;display:flex;gap:12px;align-items:center;justify-content:space-between;pointer-events:none;z-index:20}
    .hud .chiprow{display:flex;gap:10px;align-items:center;pointer-events:auto}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--line);box-shadow:var(--shadow);backdrop-filter:blur(10px);font-size:13px;color:var(--muted);user-select:none}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);box-shadow:0 0 0 3px rgba(53,208,127,.15)}
    .dot.warn{background:var(--warn);box-shadow:0 0 0 3px rgba(255,207,92,.15)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 3px rgba(255,92,122,.15)}

    .btn{pointer-events:auto;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--panel);border:1px solid var(--line);color:var(--text);box-shadow:var(--shadow);backdrop-filter:blur(10px);cursor:pointer;font-size:13px}
    .btn svg{width:16px;height:16px;opacity:.9}
    .btn:active{transform:translateY(1px)}

    .controls{position:fixed;left:16px;right:16px;bottom:16px;display:grid;grid-template-columns:1fr auto 1fr;align-items:end;gap:14px;z-index:20;pointer-events:none}
    .panel{pointer-events:auto;background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(12px);padding:12px 14px}
    .now{display:flex;flex-direction:column;gap:6px;min-width:0}
    .title{font-size:14px;font-weight:650;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .transport{display:flex;gap:10px;align-items:center;justify-content:center}
    .iconbtn{pointer-events:auto;width:44px;height:44px;display:grid;place-items:center;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);cursor:pointer}
    .iconbtn svg{width:18px;height:18px}
    .iconbtn.primary{width:54px;height:54px;border-radius:18px;background:rgba(122,167,255,.18);border-color:rgba(122,167,255,.28)}

    .toggles{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .toggle{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);cursor:pointer;font-size:13px;color:var(--muted);user-select:none}
    .toggle.on{color:var(--text);background:rgba(53,208,127,.12);border-color:rgba(53,208,127,.22)}
    .toggle .pill{width:34px;height:18px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--line);position:relative}
    .toggle .pill::after{content:"";width:14px;height:14px;border-radius:50%;background:rgba(234,240,255,.9);position:absolute;top:1px;left:2px;transition:transform .2s ease}
    .toggle.on .pill{background:rgba(53,208,127,.22)}
    .toggle.on .pill::after{transform:translateX(14px)}

    .drawer{position:fixed;top:0;right:0;height:100%;width:min(440px,92vw);background:var(--panel2);border-left:1px solid var(--line);box-shadow:var(--shadow);backdrop-filter:blur(14px);transform:translateX(102%);transition:transform .25s ease;z-index:30;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer header{padding:16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line)}
    .drawer header .h{display:flex;flex-direction:column;gap:4px}
    .drawer header .h .big{font-weight:750}
    .drawer header .h .small{font-size:12px;color:var(--muted)}
    .list{padding:10px;overflow:auto;flex:1}
    .item{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:14px;border:1px solid transparent;cursor:pointer}
    .item:hover{background:rgba(255,255,255,.06)}
    .item.active{background:rgba(122,167,255,.14);border-color:rgba(122,167,255,.25)}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);white-space:nowrap}
    .item .meta{min-width:0;display:flex;flex-direction:column;gap:2px}
    .item .meta .name{font-size:13px;font-weight:650;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .meta .url{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .uploader{padding:12px;border-top:1px solid var(--line)}
    .uploader .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    input[type="file"]{color:var(--muted)}
    .progress{width:100%;height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--line);overflow:hidden;margin-top:10px;display:none}
    .bar{height:100%;width:0%;background:rgba(122,167,255,.45)}
    .msg{margin-top:8px;font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="stage">
    <video id="player" playsinline muted autoplay></video>
  </div>

  <div class="hud">
    <div class="chiprow">
      <div class="chip"><span class="dot" id="netDot"></span><span id="statusText">Startingâ€¦</span></div>
      <div class="chip">ðŸ•’ <span id="clock">--:--:--</span></div>
      <div class="chip">ðŸŽ¬ <span id="indexText">0/0</span></div>
    </div>

    <button class="btn" id="menuBtn" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      Menu
    </button>
  </div>

  <div class="controls">
    <div class="panel now">
      <div class="title" id="nowTitle">â€”</div>
      <div class="sub" id="nowUrl">â€”</div>
    </div>

    <div class="panel transport">
      <button class="iconbtn" id="prevBtn" type="button" title="Previous">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h2v14H6zM20 6.5v11L9 12z"/></svg>
      </button>

      <button class="iconbtn primary" id="playBtn" type="button" title="Play/Pause">
        <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      </button>

      <button class="iconbtn" id="nextBtn" type="button" title="Next">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 5h2v14h-2zM4 6.5v11L15 12z"/></svg>
      </button>

      <button class="iconbtn" id="muteBtn" type="button" title="Mute/Unmute">
        <svg id="muteIcon" viewBox="0 0 24 24" fill="currentColor"><path d="M5 10v4h3l4 4V6L8 10H5z"/></svg>
      </button>
    </div>

    <div class="panel toggles">
      <div class="toggle on" id="autoNextToggle">Auto-next <span class="pill"></span></div>
      <div class="toggle" id="loopToggle">Loop <span class="pill"></span></div>
      <div class="toggle" id="shuffleToggle">Shuffle <span class="pill"></span></div>
    </div>
  </div>

  <aside class="drawer" id="drawer" aria-hidden="true">
    <header>
      <div class="h">
        <div class="big">Playlist + Upload</div>
        <div class="small">Upload videos then click to play</div>
      </div>
      <button class="btn" id="closeBtn" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
        Close
      </button>
    </header>

    <div class="list" id="list"></div>

    <div class="uploader">
      <div class="row">
        <input id="fileInput" type="file" accept="video/mp4,video/webm,video/ogg" />
        <button class="btn" id="uploadBtn" type="button">Upload</button>
      </div>
      <div class="progress" id="progress"><div class="bar" id="bar"></div></div>
      <div class="msg" id="msg">Allowed: .mp4 .webm .ogg</div>
    </div>
  </aside>

  <script>
    // ======= BASIC PLAYER (MP4/WEBM/OGG) + ONLINE UPLOAD LIST =======

    const player = document.getElementById("player");
    const nowTitle = document.getElementById("nowTitle");
    const nowUrl = document.getElementById("nowUrl");
    const indexText = document.getElementById("indexText");
    const statusText = document.getElementById("statusText");
    const netDot = document.getElementById("netDot");

    const drawer = document.getElementById("drawer");
    const menuBtn = document.getElementById("menuBtn");
    const closeBtn = document.getElementById("closeBtn");
    const listEl = document.getElementById("list");

    const prevBtn = document.getElementById("prevBtn");
    const playBtn = document.getElementById("playBtn");
    const nextBtn = document.getElementById("nextBtn");
    const muteBtn = document.getElementById("muteBtn");

    const playIcon = document.getElementById("playIcon");
    const muteIcon = document.getElementById("muteIcon");

    const autoNextToggle = document.getElementById("autoNextToggle");
    const loopToggle = document.getElementById("loopToggle");
    const shuffleToggle = document.getElementById("shuffleToggle");

    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const progress = document.getElementById("progress");
    const bar = document.getElementById("bar");
    const msg = document.getElementById("msg");

    let playlist = []; // fetched from server
    let idx = 0;
    let autoNext = true;
    let loopOne = false;
    let shuffle = false;

    function setStatus(text, level="good"){
      statusText.textContent = text;
      netDot.className = "dot" + (level === "warn" ? " warn" : level === "bad" ? " bad" : "");
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function setPlayIcon(isPlaying){
      if (isPlaying){
        playIcon.innerHTML = '<path d="M6 5h4v14H6zM14 5h4v14h-4z"/>';
      } else {
        playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
      }
    }

    function setMuteIcon(isMuted){
      if (isMuted){
        muteIcon.innerHTML = '<path d="M5 10v4h3l4 4V6L8 10H5z"/><path d="M16 9l4 6M20 9l-4 6" stroke="currentColor" stroke-width="2" fill="none"/>';
      } else {
        muteIcon.innerHTML = '<path d="M5 10v4h3l4 4V6L8 10H5z"/><path d="M14.5 9.5a3 3 0 0 1 0 5" fill="none" stroke="currentColor" stroke-width="2"/><path d="M16.8 7.2a6 6 0 0 1 0 9.6" fill="none" stroke="currentColor" stroke-width="2"/>';
      }
    }

    function openDrawer(){ drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); }
    function closeDrawer(){ drawer.classList.remove("open"); drawer.setAttribute("aria-hidden","true"); }
    menuBtn.addEventListener("click", openDrawer);
    closeBtn.addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeDrawer(); });

    function setToggle(el, on){ el.classList.toggle("on", on); }
    autoNextToggle.addEventListener("click", ()=>{ autoNext = !autoNext; setToggle(autoNextToggle, autoNext); });
    loopToggle.addEventListener("click", ()=>{ loopOne = !loopOne; player.loop = loopOne; setToggle(loopToggle, loopOne); });
    shuffleToggle.addEventListener("click", ()=>{ shuffle = !shuffle; setToggle(shuffleToggle, shuffle); });

    function renderPlaylist(){
      listEl.innerHTML = "";
      playlist.forEach((v, i) => {
        const row = document.createElement("div");
        row.className = "item" + (i === idx ? " active" : "");
        row.innerHTML = `
          <span class="badge">${String(i+1).padStart(2,"0")}</span>
          <div class="meta">
            <div class="name">${escapeHtml(v.name || ("Video " + (i+1)))}</div>
            <div class="url">${escapeHtml(v.url)}</div>
          </div>
        `;
        row.addEventListener("click", () => load(i, true));
        listEl.appendChild(row);
      });
    }

    function updateNowPlaying(){
      const v = playlist[idx] || {name:"â€”", url:"â€”"};
      nowTitle.textContent = v.name || `Video ${idx+1}`;
      nowUrl.textContent = v.url || "â€”";
      indexText.textContent = `${playlist.length ? (idx+1) : 0}/${playlist.length}`;
      renderPlaylist();
    }

    async function refreshPlaylist(autostartIfEmpty=false){
      try{
        setStatus("Fetching videosâ€¦", "warn");
        const res = await fetch("/api/videos");
        playlist = await res.json();

        if (!Array.isArray(playlist)) playlist = [];
        if (idx >= playlist.length) idx = 0;

        updateNowPlaying();
        setStatus(playlist.length ? "Ready" : "No videos (upload one)", playlist.length ? "good" : "warn");

        if (autostartIfEmpty === false && playlist.length) {
          // do nothing
        } else if (playlist.length) {
          load(idx, true);
        }
      }catch(e){
        setStatus("Server error", "bad");
      }
    }

    function load(i, shouldPlay=false){
      if (!playlist.length) return;

      idx = (i + playlist.length) % playlist.length;
      const v = playlist[idx];

      setStatus("Loadingâ€¦", "warn");
      updateNowPlaying();

      player.loop = loopOne;
      player.src = v.url;
      player.load();

      if (shouldPlay) safePlay();
    }

    async function safePlay(){
      try{
        await player.play();
        setStatus(player.muted ? "Playing (muted)" : "Playing", "good");
        setPlayIcon(true);
      }catch(err){
        setStatus("Autoplay blocked (click Play)", "warn");
        setPlayIcon(false);
      }
    }

    function next(){
      if (!playlist.length) return;
      if (shuffle) {
        let n = idx;
        while (playlist.length > 1 && n === idx) n = Math.floor(Math.random() * playlist.length);
        load(n, true);
      } else {
        load(idx + 1, true);
      }
    }
    function prev(){ if (playlist.length) load(idx - 1, true); }

    prevBtn.addEventListener("click", prev);
    nextBtn.addEventListener("click", next);

    playBtn.addEventListener("click", async ()=>{
      if (player.paused) await safePlay();
      else { player.pause(); setStatus("Paused", "warn"); setPlayIcon(false); }
    });

    muteBtn.addEventListener("click", ()=>{
      player.muted = !player.muted;
      setMuteIcon(player.muted);
      setStatus(player.paused ? "Paused" : (player.muted ? "Playing (muted)" : "Playing"), "good");
    });

    player.addEventListener("ended", ()=>{
      if (loopOne) return;
      if (autoNext) next();
      else setStatus("Ended", "warn");
    });

    player.addEventListener("playing", ()=>{ setStatus(player.muted ? "Playing (muted)" : "Playing", "good"); setPlayIcon(true); });
    player.addEventListener("pause", ()=>{ setStatus("Paused", "warn"); setPlayIcon(false); });
    player.addEventListener("waiting", ()=>{ setStatus("Bufferingâ€¦", "warn"); });
    player.addEventListener("error", ()=>{ setStatus("Error loading video", "bad"); });

    // Upload
    uploadBtn.addEventListener("click", async ()=>{
      const file = fileInput.files && fileInput.files[0];
      if (!file) { msg.textContent = "Choose a video file first."; return; }

      msg.textContent = "Uploadingâ€¦";
      progress.style.display = "block";
      bar.style.width = "0%";

      const form = new FormData();
      form.append("file", file);

      // Use XHR for progress
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/api/upload", true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable){
          const pct = Math.round((e.loaded / e.total) * 100);
          bar.style.width = pct + "%";
        }
      };

      xhr.onload = async () => {
        if (xhr.status >= 200 && xhr.status < 300){
          msg.textContent = "Uploaded âœ… Refreshing listâ€¦";
          await refreshPlaylist(true);
          fileInput.value = "";
        } else {
          msg.textContent = "Upload failed: " + xhr.responseText;
        }
        setTimeout(()=>{ progress.style.display="none"; }, 800);
      };

      xhr.onerror = () => {
        msg.textContent = "Upload error (server not reachable).";
        progress.style.display = "none";
      };

      xhr.send(form);
    });

    // Clock
    function tick(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      document.getElementById("clock").textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    setInterval(tick, 250); tick();

    // Init
    setMuteIcon(true);
    setToggle(autoNextToggle, autoNext);
    setToggle(loopToggle, loopOne);
    setToggle(shuffleToggle, shuffle);
    refreshPlaylist(false);
  </script>
</body>
</html>
