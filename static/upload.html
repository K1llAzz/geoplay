<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GeoPlay — Upload</title>
  <style>
    body{margin:0;font-family:system-ui;background:#0b0f1a;color:#eaf0ff;display:grid;place-items:center;min-height:100vh}
    .box{width:min(620px,92vw);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:18px}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:#eaf0ff;margin-top:10px}
    button{margin-top:12px;width:100%;padding:12px;border-radius:12px;border:1px solid rgba(122,167,255,.28);background:rgba(122,167,255,.18);color:#eaf0ff;cursor:pointer}
    .msg{opacity:.8;margin-top:10px;font-size:13px;min-height:18px}
    .progress{margin-top:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);overflow:hidden;display:none}
    .bar{height:100%;width:0%;background:rgba(122,167,255,.45)}
    .pct{margin-top:8px;color:#7aa7ff;font-weight:700;display:none}
    a{color:#7aa7ff;text-decoration:none}
  </style>
</head>
<body>
  <div class="box">
    <h2 style="margin:0 0 8px;">Upload Video</h2>
    <div style="opacity:.75;margin-bottom:12px;">
      <a href="/">Home</a> • <a href="/login">Login</a>
    </div>

    <div id="me" style="opacity:.8;">Checking login…</div>

    <input id="title" placeholder="Title (required)"/>
    <input id="category" placeholder="Category (e.g. Music, Gaming, Vlog)"/>
    <input id="file" type="file" accept="video/mp4,video/webm,video/ogg"/>

    <button id="btn">Upload</button>

    <div class="progress" id="progress"><div class="bar" id="bar"></div></div>
    <div class="pct" id="pct">0%</div>
    <div class="msg" id="msg"></div>
  </div>

<script>
  const me = document.getElementById("me");
  const title = document.getElementById("title");
  const category = document.getElementById("category");
  const file = document.getElementById("file");
  const btn = document.getElementById("btn");
  const msg = document.getElementById("msg");
  const progress = document.getElementById("progress");
  const bar = document.getElementById("bar");
  const pct = document.getElementById("pct");

  async function api(path){ const r = await fetch(path); return r.json(); }

  async function checkMe(){
    const data = await api("/api/me");
    if(!data.logged_in){
      me.textContent = "Not logged in. You must login to upload.";
      btn.disabled = true;
      btn.style.opacity = .6;
    }else{
      me.textContent = "Logged in: " + data.username;
      btn.disabled = false;
      btn.style.opacity = 1;
    }
  }

  btn.onclick = ()=>{
    const f = file.files && file.files[0];
    if(!f){ msg.textContent = "Choose a video file."; return; }
    if(!title.value.trim()){ msg.textContent = "Title is required."; return; }

    msg.textContent = "Uploading…";
    progress.style.display = "block";
    pct.style.display = "block";
    bar.style.width = "0%";
    pct.textContent = "0%";

    const fd = new FormData();
    fd.append("file", f);
    fd.append("title", title.value.trim());
    fd.append("category", (category.value.trim() || "Uncategorized"));

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/api/upload", true);

    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable){
        const p = Math.round((e.loaded / e.total) * 100);
        bar.style.width = p + "%";
        pct.textContent = p + "%";
      }
    };

    xhr.onload = ()=>{
      if(xhr.status >= 200 && xhr.status < 300){
        pct.textContent = "100%";
        msg.textContent = "Uploaded ✅ Redirecting to Home…";
        setTimeout(()=>location.href="/", 700);
      } else {
        msg.textContent = "Upload failed: " + xhr.responseText;
      }
      setTimeout(()=>{ progress.style.display="none"; }, 1200);
    };

    xhr.onerror = ()=>{
      msg.textContent = "Upload error (server not reachable).";
      progress.style.display="none";
    };

    xhr.send(fd);
  };

  checkMe();
</script>
</body>
</html>
